# OpenSpec 模板关键要素整理

本文档整理了 `proposal.md`、`design.md`、`tasks.md`、`spec.md` 四个模板文件的关键要素。

---

## 一、proposal.md（概设文档）

### 核心定位
- **作用**：需求描述、产品交互、系统时序图
- **性质**：概设文档，描述"做什么"和"为什么"

### 关键要素

#### 1. 需求描述
- **内容**：需求背景、业务诉求
- **要求**：简练语言描述关键要素

#### 2. 产品交互（可选）
- **内容**：C端客户动线，或运营内管操作动线
- **格式**：使用 mermaid 时序图描述

#### 3. 系统间时序图（必须）
- **目的**：明确系统职责边界，确认分工
- **格式**：使用 mermaid 格式绘制
- **内容粒度要求**：
  - 人->系统：xx角色访问xx页面，操作xx内容
  - 系统->系统：A调用B的xx接口（rmb或者http），做xx动作
- **特殊标记**：
  - 差异分支流程用 `alt` 标签
  - 并发用 `par` 标签
  - 调用内部组件用自引用标识，并写出组件名和目的

#### 4. 详设文档说明
- **说明**：本需求的详设包含两部分
  - `design.md`：技术设计详情（接口设计、数据库设计、运维专项等）
  - `specs/[capability]/spec.md`：功能点详细流程图和场景描述
- **位置**：
  - `openspec/changes/[change-id]/design.md`
  - `openspec/changes/[change-id]/specs/[capability]/spec.md`

---

## 二、design.md（详设文档 - 必须）

### 核心定位
- **作用**：技术设计详情（接口设计、数据库设计、运维专项等）
- **性质**：详设文档，描述"怎么做"
- **重要性**：必须创建

### 关键要素

#### 一、系统模型与本次改动
1. **系统模型总图**
   - 在 `proposal.md` 中的系统间时序图基础上，详细描述系统模型

2. **改动点说明**
   - **改动背景**：为什么要改
   - **改动范围**：影响哪些模块/组件
   - **改动目的**：达成什么目标
   - **与 proposal.md 的关系**：如何对应概设中的时序图

#### 二、接口设计
1. **接口定义清单**
   - 列出所有涉及的接口，明确是新增还是修改
   - 表格格式：接口路径 | 方法 | 类型 | 说明 | 修改点

2. **接口详细设计**
   - 接口名称
   - 路径
   - 请求参数（JSON 格式示例）
   - 返回结果（JSON 格式示例）
   - 枚举值说明
   - 错误码

3. **接口流程图（详设关键产出，AI 生成代码关键输入）**
   - 需绘制 场景 - 功能点 - 接口 向下流程图
   - 使用 mermaid 格式
   - 与 `specs/` 下的 spec.md 中的 Scenario 流程图相对应，但更详细
   - **流程图要求**：
     - 包括所有主流程 + 所有分支流程、分支判断逻辑
     - 每条流转路径需明确 4 要素：
       1. **前置条件**：含"当前状态校验 + 业务规则"
       2. **触发动作**：细化到"用户操作/系统任务/外部回调"
       3. **后置操作**：含"主档状态更新 + 关联操作 + 日志"
       4. **关联接口/组件**：补充方法签名

#### 三、组件设计
1. **组件定义**
   - 组件指可在多产品领域复用的流程中的公共逻辑

2. **组件说明**（若需求涉及组件）
   - 功能描述：组件做什么
   - 复用场景：在哪些场景使用
   - 输入参数：参数列表
   - 输出参数：返回值
   - 交互关系：与其他组件的关系

3. **注意事项**
   - 若不涉及组件，标注："本需求无相关组件设计"
   - 新增组件：需拉相关领域同事评审

#### 四、数据库设计
1. **设计原则**
   - 字段设计：遵循项目规约（见 `openspec/project.md`）
   - 数据管理：遵循数据管理规范

2. **表结构设计**
   - 表名
   - 表说明
   - 字段列表（表格格式）：字段名 | 类型 | 长度 | 是否必填 | 说明 | 索引
   - 表关系说明
   - ER 图（可选）：可使用 mermaid 绘制

#### 五、关键功能与测试重点
1. **关键功能说明**（针对触客、资损相关的关键功能改动）
   - 业务逻辑
   - 触发条件
   - 处理流程
   - 涉及的业务规则

2. **测试重点**
   - 功能正确性测试：关键功能是否符合业务需求
   - 异常场景测试：如触客渠道故障、资损数据异常时的功能表现和 SOP 方法

3. **异常处理预案**（触客、资损场景必须有）
   - 异常场景现象
   - 处理方案 SOP

4. **兼容性**
   - 参考金融严谨性"兼容性"章节

#### 六、运维专项
1. **必须项**
   - **版本信息**：版本号、发布时间、依赖版本
   - **兼容性设计**：向前兼容、向后兼容、灰度策略
   - **IT验证方法**：单元测试、集成测试、性能测试、验收标准
   - **回滚方案**：回滚触发条件、回滚步骤、数据回滚

2. **数据清洗（必须场景）**
   - 以下场景必须提供数据清洗方案：
     1. 数据修改超过5000或修改业务数据表超过单表数据量20%
     2. 数据清洗违反基本原则（未走索引、无备份、无回退方案）但确认需要执行
     3. 数据清洗流程复杂且历史未执行过，有时序要求且与业务强耦合
     4. 操作手册缺乏必要部分（风险评估、操作方案、验证方案、回退方案）
     5. 数据清洗影响业务可用率或需要业务停服配合
     6. 运维评估存在高风险的修数方案
   - **数据清洗方案模板**：
     - 风险评估
     - 操作方案（详细的SQL或脚本，包含备份步骤）
     - 验证方案
     - 回退方案

3. **其他运维项**
   - **数据清理**：新增流水表必须说明清理策略（清理周期、清理方式）
   - **功能开关**（关键功能必须）：开关名称、默认状态、开启条件
   - **HOLD批量**（关键功能必须）：HOLD机制、恢复机制

---

## 三、tasks.md（实施步骤）

### 核心定位
- **作用**：实施检查清单
- **性质**：实施步骤跟踪

### 关键要素

1. **重要提醒**
   - 实施前请务必阅读 `openspec/project.md` 了解项目开发规约和编码规范

2. **实施步骤**
   - 使用有序列表格式：`- [ ] 1.1 数据库设计`
   - 按顺序列出任务项
   - 完成后标记为 `- [x]`

3. **典型步骤示例**
   - 1.1 数据库设计
   - 1.2 组件开发（如有）
   - 1.3 接口实现
   - 1.4 测试验证

---

## 四、spec.md（功能点详细流程图和场景描述）

### 核心定位
- **作用**：功能点详细流程图和场景描述
- **性质**：详设文档，描述功能点的具体实现场景
- **位置**：`openspec/changes/[change-id]/specs/[capability]/spec.md`

### 关键要素

#### 1. Delta 操作类型
使用以下标题之一：
- `## ADDED Requirements` - 新增能力
- `## MODIFIED Requirements` - 变更行为
- `## REMOVED Requirements` - 废弃功能
- `## RENAMED Requirements` - 名称变更

#### 2. Requirement 格式
```markdown
### Requirement: 功能名称
系统应当提供...的能力
```

**要求**：
- 使用"应当"、"必须"等规范性词语描述需求
- Requirement 名称可以使用中文

#### 3. Scenario 格式（必须）
```markdown
#### Scenario: 场景名称
使用 mermaid 流程图描述，必须包含4要素：
1. 前置条件：含"当前状态校验 + 业务规则"
2. 触发动作：细化到"用户操作/系统任务/外部回调"
3. 后置操作：含"主档状态更新 + 关联操作 + 日志"
4. 关联接口/组件：补充方法签名或接口 URL + 参数
```

**格式要求**：
- 使用 `#### Scenario:` 标题（4个井号）
- 标题下方使用 mermaid 流程图描述场景
- 每个 requirement 必须至少有一个 scenario
- 流程图必须包含4要素：前置条件、触发动作、后置操作、关联接口/组件

**正确格式示例**：
```markdown
#### Scenario: 用户登录成功
\`\`\`mermaid
flowchart TD
    A[前置条件: 用户已注册 且 账号状态正常] --> B[触发动作: 用户输入用户名密码点击登录]
    B --> C[后置操作: 生成 JWT token 并更新登录时间]
    C --> D[关联接口: POST /api/v1/auth/login]
\`\`\`
```

**错误格式**（不要使用）：
- `- **Scenario: User login**` ❌
- `**Scenario**: User login` ❌
- `### Scenario: User login` ❌

#### 4. MODIFIED Requirements 编写要求
1. 在 `openspec/specs/<capability>/spec.md` 中定位现有需求
2. 复制整个需求块（从 `### Requirement: ...` 到它的所有场景）
3. 将其粘贴到 `## MODIFIED Requirements` 下并编辑以反映新行为
4. 确保标题文本精确匹配（忽略空白符）并保留至少一个 `#### Scenario:`

#### 5. RENAMED Requirements 格式
```markdown
## RENAMED Requirements
- FROM: `### Requirement: 用户登录`
- TO: `### Requirement: 用户身份认证`
```

#### 6. REMOVED Requirements 格式
```markdown
## REMOVED Requirements
### Requirement: 旧功能名称
**移除原因**: [说明为何移除]
**迁移方案**: [如何处理现有使用]
```

#### 7. 多能力域处理
如果影响多个能力域，在 `changes/[change-id]/specs/<capability>/spec.md` 下创建多个 delta 文件—每个能力域一个。

---

## 总结对比

| 文档 | 定位 | 必须性 | 主要内容 |
|------|------|--------|----------|
| **proposal.md** | 概设 | 必须 | 需求描述、产品交互、系统时序图 |
| **design.md** | 详设 | 必须 | 接口设计、数据库设计、运维专项 |
| **tasks.md** | 实施清单 | 必须 | 实施步骤检查清单 |
| **spec.md** | 功能详设 | 必须 | 功能点流程图和场景描述 |

### 文档关系
- `proposal.md` 提供概设，描述"做什么"
- `design.md` 提供技术详设，描述"怎么做"
- `spec.md` 提供功能点详设，描述"具体场景"
- `tasks.md` 提供实施步骤，描述"如何实施"

### 关键原则
1. **proposal.md**：系统间时序图必须使用 mermaid 格式，明确系统职责边界
2. **design.md**：接口流程图必须包含4要素（前置条件、触发动作、后置操作、关联接口/组件）
3. **spec.md**：每个 Requirement 必须至少有一个 Scenario，使用 mermaid 流程图描述
4. **tasks.md**：按顺序列出任务，完成后标记为 `- [x]`

